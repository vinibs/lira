var Core=function(e){this.router=e;e.basepath,e.clearpath;this.pageContents=[],this.checkPageContent=function(e){for(var t=0;t<this.pageContents.length;t++)if(this.pageContents[t].url===e)return!0;return!1},this.adjustLinks=function(){var e=document.getElementsByTagName("a"),t=document.getElementsByTagName("images"),n="";""!==this.router.clearpath&&(n+="(("+this.router.clearpath.replace(/\//g,"\\/")+").*)|"),n+="((http:\\/\\/).*)|((\\/\\/).*)";for(var r=new RegExp(n),s=0;s<e.length;s++)if(!r.test(e[s].getAttribute("href"))){var a=e[s].getAttribute("href");a=this.adjustUrl(a),e[s].setAttribute("href",a),this.router.setLink(e[s])}for(s=0;s<t.length;s++)if(!r.test(t[s].getAttribute("src"))){var i=t[s].getAttribute("src");t[s].setAttribute("src",this.router.clearpath+"/"+i)}},this.adjustUrl=function(e){var t="(("+this.router.clearpath.replace(/\//g,"\\/")+").*)|((http:\\/\\/).*)|((\\/\\/).*)";return new RegExp(t).test(e)||("/"===e&&(e=""),e=this.router.clearpath+"/"+e),e},this.adjustRefs=function(){for(var e=document.getElementsByTagName("link"),t=document.getElementsByTagName("script"),n="(("+this.router.clearpath.replace(/\//g,"\\/")+").*)|((http:\\/\\/).*)|((\\/\\/).*)",r=new RegExp(n),s=0;s<e.length;s++)if(!r.test(e[s].getAttribute("href"))){var a=e[s].getAttribute("href");e[s].setAttribute("href",this.adjustUrl(a))}for(s=0;s<t.length;s++)if(!r.test(t[s].getAttribute("src"))){var i=t[s].parentNode,o=t[s].getAttribute("src");t[s].setAttribute("src",this.adjustUrl(o));var l=document.createElement("script");l.setAttribute("src",this.router.clearpath+"/"+o),l.setAttribute("tyle",t[s].getAttribute("type")),i.replaceChild(l,t[s])}},this.toAbsolutePath=function(e,t){"/"===t.charAt(0)&&(t=t.substring(1));var n=e.split("/"),r=t.split("/");n.pop();for(var s=0;s<r.length;s++)"."!==r[s]&&(".."===r[s]?n.pop():n.push(r[s]));return n.join("/")},this.importFile=function(e,t){e="/"===e.charAt(e.length-1)?e.substring(0,e.length-1):e;var n=this;if(this.checkPageContent(e)){for(var r={},s=0;s<this.pageContents.length;s++)if(e===this.pageContents[s].url){r={response:this.pageContents[s].content,responseUrl:this.pageContents[s].url};break}t(r)}else{var a=new XMLHttpRequest;a.open("GET",e,!0),a.send();var i=setInterval(function(){""!==a.response&&(n.checkPageContent(e)||n.pageContents.push({url:e,content:a.response}),t(a),clearInterval(i))},20)}},this.importAndExec=function(t,n){var r=this,s=document.getElementById("route-content"),a=!1,o=e.basepath+"/src/app/pages/";t.setup="/"!==t.setup.charAt(0)?t.setup:t.setup.substring(1);var l=o+t.setup+".page.js";n=void 0!==n?n:"";var u=document.getElementById("page-script");null!==u&&s.removeChild(u),window.page=null;var c=document.createElement("script");c.src=l,c.id="page-script",s.appendChild(c);var h=setInterval(function(){if(null!==page){if(null===document.getElementById("globalScript")){var l=document.createElement("script");l.id="globalScript",l.src=e.basepath+"/src/app/global/main.js",document.head.appendChild(l)}var u=document.getElementsByClassName("dynamicStyle");for(i=0;i<u.length;i++)u[i].setAttribute("class","dynamicStyle old");void 0!==page.title?document.title=page.title:document.title=r.pageContents[0].title,"/"===t.setup.charAt(0)&&(t.setup=t.setup.substring(1));var c=t.setup.split("/");c[c.length-1]="";var p=o+c.join("/");if(void 0!==page.pageFile){var d=r.toAbsolutePath(p,page.pageFile);r.importFile(d,function(e){if(""!==e.response){if(e.response!==r.pageContents[0].content){if(void 0!==page.styleFile)var t=setInterval(function(){document.getElementsByClassName("dynamicStyle").length>0&&(s.innerHTML=e.response,clearInterval(t))},20);else s.innerHTML=e.response;window.scrollTo(0,0)}if(new RegExp(/<a.*>.*<\/a>/g).test(e.response))var n=setInterval(function(){document.getElementsByTagName("a").length>0&&(r.adjustLinks(),clearInterval(n))},20)}})}if(void 0!==page.styleFile){var g=r.toAbsolutePath(p,page.styleFile);r.importFile(g,function(e){if(e.response!==r.pageContents[0].content&&!a){var t=document.createElement("link");for(t.type="text/css",t.href=g,t.rel="stylesheet",t.className="dynamicStyle",document.head.appendChild(t),a=!0,u=document.getElementsByClassName("dynamicStyle old"),i=0;i<u.length;i++)document.head.removeChild(u[i])}})}else for(i=0;i<u.length;i++)document.head.removeChild(u[i]);void 0!==page.handler&&setTimeout(function(){if(void 0!==page.pageFile)var e=setInterval(function(){""!==s&&(page.handler(n),clearInterval(e),0)},20);else page.handler(n)},20),clearInterval(h)}},20)}},Router=function(){this.core=new Core(this),this.getRootPath=function(){return location.protocol+"//"+location.host+"/"},this.getExtraPath=function(){var e=(this.getRootPath()+document.location.pathname.substring(1)).substring(this.basepath.length);return"/"===e.substring(0,1)&&(e=e.substring(1)),e},this.getBasePath=function(){var e=document.getElementsByTagName("base")[0].href,t=e.substring(0,1),n=e.substring(e.length-1);return"/"===t&&(e=e.substring(1)),"/"===n&&(e=e.substring(0,e.length-1)),e},this.getClearRelativePath=function(){var e=document.getElementsByTagName("base")[0].getAttribute("href"),t=e.substring(0,1),n=e.substring(e.length-1);return"/"!==t&&(e="/"+e.substring(1)),"/"===n&&(e=e.substring(0,e.length-1)),e},this.basepath=this.getBasePath(),this.clearpath=this.getClearRelativePath(),this.setLink=function(e){var t=this,n=e.getAttribute("href"),r=e.getAttribute("target"),s=null===r||"_self"===r||"self"===r;e.onclick=function(r){if(s){if(r.preventDefault(),null!==e.getAttribute("onclick"))new Function(e.getAttribute("onclick")).apply(this);var a={Title:"",Url:n};history.pushState(a,a.Title,a.Url),t.execute()}}},this.execute=function(){for(var e=this.getExtraPath(),t=0;t<routes.length;t++){if(""===e&&(""===routes[t].path||"/"===routes[t].path)||e===routes[t].path)return void this.core.importAndExec(routes[t]);var n="",r="";n="/"===routes[t].path.charAt(routes[t].path.length-1)?routes[t].path.substring(0,routes[t].path.length-1):routes[t].path,n="/"===routes[t].path.charAt(0)?n.substring(1):n,r="/"===e.charAt(e.length-1)?e.substring(0,e.length-1):e,r="/"===e.charAt(0)?r.substring(1):r;var s=n.split("/"),a=r.split("/");if(a.length===s.length)for(var i=0;i<a.length&&(a[i]===s[i]||/{.+}/g.test(s[i]));i++)if(i===a.length-1){for(var o=[],l=0;l<s.length;l++)if(/{.+}/g.test(s[l])){var u=/({.+})/g.exec(s[l])[0].replace(/[{}]/g,"");o.push({name:u,content:a[l]})}var c={};for(l=0;l<o.length;l++)c[o[l].name]=o[l].content;return void this.core.importAndExec(routes[t],c)}if("*"===n.trim()){var h=this.core,p=routes[t];return void this.core.importFile(e,function(t){t.response===h.pageContents[0].content?h.importAndExec(p):window.location.replace(e)})}}var d=this;p=routes[t];this.core.importFile(e,function(n){if(n.response===d.core.pageContents[0].content){var r=document.getElementsByClassName("dynamicStyle");for(t=0;t<r.length;t++)document.head.removeChild(r[t]);null!==document.getElementById("page-script")&&document.head.removeChild(prevSript);var s=document.getElementById("route-content");s.innerHTML="<h1>Page not found </h1>",s.innerHTML+="<h4>(HTTP 404)</h4>";var a=document.createElement("a"),i=document.createTextNode("Go back to home");a.setAttribute("href",d.basepath),a.appendChild(i),s.appendChild(a),d.setLink(a)}else window.location.replace(e)})}},App=function(){var e=!1,t=new Router,n=t.core;this.data=[];var r=function(){if(e=!0,0===document.getElementsByClassName("mainCss").length){var r=t.clearpath+"/main.css",s=document.createElement("link");s.type="text/css",s.rel="stylesheet",s.href=r,s.className="mainCss",document.head.appendChild(s)}n.importFile("src/app/app.body.html",function(e){if(document.body.innerHTML=e.response,null===document.getElementById("route-list")){var r=document.createElement("script");r.src=t.basepath+"/src/app/app.routes.js",r.setAttribute("id","route-list"),r.type="text/javascript",document.getElementById("route-content").appendChild(r)}var s=setInterval(function(){"undefined"!=typeof routes&&(t.execute(),n.adjustRefs(),n.adjustLinks(),clearInterval(s))},10)})};return this.ajax=function(e){e.method=void 0!==e.method?e.method:"GET",e.async=void 0===e.async||e.async,e.url=void 0!==e.url?n.adjustUrl(e.url):"",e.data=void 0!==e.data?e.data:"",e.contentType=void 0!==e.contentType?e.contentType:"",e.headers=void 0!==e.headers?e.headers:"",e.beforeSend=void 0!==e.beforeSend?e.beforeSend:null,e.success=void 0!==e.success?e.success:null,e.fail=void 0!==e.fail?e.fail:null,null!==e.beforeSend&&e.beforeSend();var t=new XMLHttpRequest;if(t.open(e.method,e.url,e.async),""!==e.contentType&&t.setRequestHeader("Content-Type",e.contentType),new RegExp("application/json.").test(e.contentType)&&(e.data=JSON.stringify(e.data)),""!==e.headers)for(var r=Object.keys(e.headers),s=0;s<r.length;s++)t.setRequestHeader(r[s],e.headers[r[s]]);t.send(e.data);var a=setInterval(function(){""!==t.response&&(t.status>=200&&t.status<300?null!==e.success&&e.success(t):null!==e.fail&&e.fail(t),clearInterval(a))},20)},this.redirect=function(e){""!==e&&"/"!==e||(e=t.basepath);var n={Title:"",Url:e};history.pushState(n,n.Title,n.Url),t.execute()},window.onpopstate=function(){return r()},n.importFile(t.clearpath,function(s){""===s.response.trim()||e||(n.pageContents[0]={url:t.clearpath,content:s.response,title:document.title,name:"base"},r())})};window.onload=function(){window.app=new App};