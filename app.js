var Core=function(t){this.router=t;t.basepath,t.clearpath;this.pageContents=[],this.checkPageContent=function(t){for(var e=0;e<this.pageContents.length;e++)if(this.pageContents[e].url===t)return!0;return!1},this.adjustLinks=function(){var t=document.getElementsByTagName("a"),e=document.getElementsByTagName("images"),n="";""!==this.router.clearpath&&(n+="(("+this.router.clearpath.replace(/\//g,"\\/")+").*)|"),n+="((http:\\/\\/).*)|((\\/\\/).*)";for(var r=new RegExp(n),s=0;s<t.length;s++)if(!r.test(t[s].getAttribute("href"))){var a=t[s].getAttribute("href");a=this.adjustUrl(a),t[s].setAttribute("href",a),this.router.setLink(t[s])}for(s=0;s<e.length;s++)if(!r.test(e[s].getAttribute("src"))){var i=e[s].getAttribute("src");e[s].setAttribute("src",this.router.clearpath+"/"+i)}},this.adjustUrl=function(t){var e="(("+this.router.clearpath.replace(/\//g,"\\/")+").*)|((http:\\/\\/).*)|((\\/\\/).*)";return new RegExp(e).test(t)||("/"===t&&(t=""),t=this.router.clearpath+"/"+t),t},this.adjustRefs=function(){for(var t=document.getElementsByTagName("link"),e=document.getElementsByTagName("script"),n="(("+this.router.clearpath.replace(/\//g,"\\/")+").*)|((http:\\/\\/).*)|((\\/\\/).*)",r=new RegExp(n),s=0;s<t.length;s++)if(!r.test(t[s].getAttribute("href"))){var a=t[s].getAttribute("href");t[s].setAttribute("href",this.adjustUrl(a))}for(s=0;s<e.length;s++)if(!r.test(e[s].getAttribute("src"))){var i=e[s].parentNode,o=e[s].getAttribute("src");e[s].setAttribute("src",this.adjustUrl(o));var l=document.createElement("script");l.setAttribute("src",this.router.clearpath+"/"+o),l.setAttribute("tyle",e[s].getAttribute("type")),i.replaceChild(l,e[s])}},this.toAbsolutePath=function(t,e){"/"===e.charAt(0)&&(e=e.substring(1));var n=t.split("/"),r=e.split("/");n.pop();for(var s=0;s<r.length;s++)"."!==r[s]&&(".."===r[s]?n.pop():n.push(r[s]));return n.join("/")},this.importFile=function(t,e){t="/"===t.charAt(t.length-1)?t.substring(0,t.length-1):t;var n=this;if(this.checkPageContent(t)){for(var r={},s=0;s<this.pageContents.length;s++)if(t===this.pageContents[s].url){r={response:this.pageContents[s].content,responseUrl:this.pageContents[s].url};break}e(r)}else{var a=new XMLHttpRequest;a.open("GET",t,!0),a.send();var i=setInterval(function(){""!==a.response&&(n.checkPageContent(t)||n.pageContents.push({url:t,content:a.response}),e(a),clearInterval(i))},20)}},this.importAndExec=function(e,n){var r=this,s=document.getElementById("route-content"),a=!1,o=t.basepath+"/src/app/pages/";e.setup="/"!==e.setup.charAt(0)?e.setup:e.setup.substring(1);var l=o+e.setup+".page.js";n=void 0!==n?n:"";var u=document.getElementById("page-script");null!==u&&s.removeChild(u),window.page=null;var c=document.createElement("script");c.src=l,c.id="page-script",s.appendChild(c);var h=setInterval(function(){if(null!==page){if(null===document.getElementById("globalScript")){var l=document.createElement("script");l.id="globalScript",l.src=t.basepath+"/src/app/global/main.js",document.head.appendChild(l)}var u=document.getElementsByClassName("dynamicStyle");for(i=0;i<u.length;i++)u[i].setAttribute("class","dynamicStyle old");void 0!==page.title?document.title=page.title:document.title=r.pageContents[0].title,"/"===e.setup.charAt(0)&&(e.setup=e.setup.substring(1));var c=e.setup.split("/");c[c.length-1]="";var p=o+c.join("/");if(void 0!==page.pageFile){var g=r.toAbsolutePath(p,page.pageFile);r.importFile(g,function(t){if(""!==t.response){if(t.response!==r.pageContents[0].content){if(void 0!==page.styleFile)var e=setInterval(function(){document.getElementsByClassName("dynamicStyle").length>0&&(s.innerHTML=t.response,clearInterval(e))},20);else s.innerHTML=t.response;window.scrollTo(0,0)}if(new RegExp(/<a.*>.*<\/a>/g).test(t.response))var n=setInterval(function(){document.getElementsByTagName("a").length>0&&(r.adjustLinks(),clearInterval(n))},20)}})}if(void 0!==page.styleFile){var d=r.toAbsolutePath(p,page.styleFile);r.importFile(d,function(t){if(t.response!==r.pageContents[0].content&&!a){var e=document.createElement("link");for(e.type="text/css",e.href=d,e.rel="stylesheet",e.className="dynamicStyle",document.head.appendChild(e),a=!0,u=document.getElementsByClassName("dynamicStyle old"),i=0;i<u.length;i++)document.head.removeChild(u[i])}})}else for(i=0;i<u.length;i++)document.head.removeChild(u[i]);void 0!==page.handler&&setTimeout(function(){if(void 0!==page.pageFile)var t=setInterval(function(){""!==s&&(page.handler(n),clearInterval(t),0)},20);else page.handler(n)},20),clearInterval(h)}},20)}},Router=function(){this.core=new Core(this),this.getRootPath=function(){return location.protocol+"//"+location.host+"/"},this.getExtraPath=function(){var t=(this.getRootPath()+document.location.pathname.substring(1)).substring(this.basepath.length);return"/"===t.substring(0,1)&&(t=t.substring(1)),t},this.getBasePath=function(){var t=document.getElementsByTagName("base")[0].href,e=t.substring(0,1),n=t.substring(t.length-1);return"/"===e&&(t=t.substring(1)),"/"===n&&(t=t.substring(0,t.length-1)),t},this.getClearRelativePath=function(){var t=document.getElementsByTagName("base")[0].getAttribute("href"),e=t.substring(0,1),n=t.substring(t.length-1);return"/"!==e&&(t="/"+t.substring(1)),"/"===n&&(t=t.substring(0,t.length-1)),t},this.basepath=this.getBasePath(),this.clearpath=this.getClearRelativePath(),this.setLink=function(t){var e=this,n=t.getAttribute("href"),r=t.getAttribute("target"),s=null===r||"_self"===r||"self"===r;t.onclick=function(r){if(s){if(r.preventDefault(),null!==t.getAttribute("onclick"))new Function(t.getAttribute("onclick")).apply(this);var a={Title:"",Url:n};history.pushState(a,a.Title,a.Url),e.execute()}}},this.execute=function(){for(var t=this.getExtraPath(),e=0;e<routes.length;e++){if(""===t&&(""===routes[e].path||"/"===routes[e].path)||t===routes[e].path)return void this.core.importAndExec(routes[e]);var n="",r="";n="/"===routes[e].path.charAt(routes[e].path.length-1)?routes[e].path.substring(0,routes[e].path.length-1):routes[e].path,n="/"===routes[e].path.charAt(0)?n.substring(1):n,r="/"===t.charAt(t.length-1)?t.substring(0,t.length-1):t,r="/"===t.charAt(0)?r.substring(1):r;var s=n.split("/"),a=r.split("/");if(a.length===s.length)for(var i=0;i<a.length&&(a[i]===s[i]||/{.+}/g.test(s[i]));i++)if(i===a.length-1){for(var o=[],l=0;l<s.length;l++)if(/{.+}/g.test(s[l])){var u=/({.+})/g.exec(s[l])[0].replace(/[{}]/g,"");o.push({name:u,content:a[l]})}var c={};for(l=0;l<o.length;l++)c[o[l].name]=o[l].content;return void this.core.importAndExec(routes[e],c)}if("*"===n.trim()){var h=this.core,p=routes[e];return void this.core.importFile(t,function(e){e.response===h.pageContents[0].content?h.importAndExec(p):window.location.replace(t)})}}var g=this;p=routes[e];this.core.importFile(t,function(n){if(n.response===g.core.pageContents[0].content){var r=document.getElementsByClassName("dynamicStyle");for(e=0;e<r.length;e++)document.head.removeChild(r[e]);null!==document.getElementById("page-script")&&document.head.removeChild(prevSript);var s=document.getElementById("route-content");s.innerHTML="<h1>Page not found </h1>",s.innerHTML+="<h4>(HTTP 404)</h4>";var a=document.createElement("a"),i=document.createTextNode("Go back to home");a.setAttribute("href",g.basepath),a.appendChild(i),s.appendChild(a),g.setLink(a)}else window.location.replace(t)})}},App=function(){var t=!1,e=new Router,n=e.core;this.data=[];var r=function(){if(t=!0,0===document.getElementsByClassName("mainCss").length){var r=e.clearpath+"/main.css",s=document.createElement("link");s.type="text/css",s.rel="stylesheet",s.href=r,s.className="mainCss",document.head.appendChild(s)}n.importFile("src/app/app.body.html",function(t){if(document.body.innerHTML=t.response,null===document.getElementById("route-list")){var r=document.createElement("script");r.src=e.basepath+"/src/app/app.routes.js",r.setAttribute("id","route-list"),r.type="text/javascript",document.getElementById("route-content").appendChild(r)}var s=setInterval(function(){"undefined"!=typeof routes&&(e.execute(),n.adjustRefs(),n.adjustLinks(),clearInterval(s))},10)})};return this.ajax=function(t){t.method=void 0!==t.method?t.method:"GET",t.async=void 0===t.async||t.async,t.url=void 0!==t.url?n.adjustUrl(t.url):"",t.data=void 0!==t.data?t.data:"",t.contentType=void 0!==t.contentType?t.contentType:"",t.headers=void 0!==t.headers?t.headers:"",t.success=void 0!==t.success?t.success:null,t.fail=void 0!==t.fail?t.fail:null;var e=new XMLHttpRequest;if(e.open(t.method,t.url,t.async),""!==t.contentType&&e.setRequestHeader("Content-Type",t.contentType),new RegExp("application/json.").test(t.contentType)&&(t.data=JSON.stringify(t.data)),""!==t.headers)for(var r=Object.keys(t.headers),s=0;s<r.length;s++)e.setRequestHeader(r[s],t.headers[r[s]]);e.send(t.data);var a=setInterval(function(){""!==e.response&&(e.status>=200&&e.status<300?null!==t.success&&t.success(e):null!==t.fail&&t.fail(e),clearInterval(a))},20)},this.redirect=function(t){""!==t&&"/"!==t||(t=e.basepath);var n={Title:"",Url:t};history.pushState(n,n.Title,n.Url),e.execute()},window.onpopstate=function(){return r()},n.importFile(e.clearpath,function(s){""===s.response.trim()||t||(n.pageContents[0]={url:e.clearpath,content:s.response,title:document.title,name:"base"},r())})};window.onload=function(){window.app=new App};